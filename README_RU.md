# MP3 AutoCut — GUI и CLI-утилита для нарезки MP3

MP3 AutoCut — это программа с удобным графическим интерфейсом (GUI), которая автоматически делит длинные MP3-файлы (например, аудиокниги, лекции, подкасты, диктофонные записи) на короткие удобные части. Она ищет естественные паузы (тишину) и режет аудио так, чтобы не обрывать фразы. Можно менять скорость воспроизведения, а готовые файлы легко скопировать на внешний диск — при этом сохраняется правильный порядок для прослушивания на наушниках Shokz. Особенно полезно для Shokz, где нельзя перематывать на 30-60 секунд: просто нарежь аудио на короткие файлы и переключайся между ними двойным или тройным нажатием на Shokz.

Для продвинутых пользователей также доступен запуск через командную строку (CLI).

**Рекомендуемый способ установки и запуска — через виртуальное окружение (venv).** Это обеспечит изоляцию зависимостей проекта и поможет избежать многих распространенных проблем.

## Графический интерфейс (GUI)

Основной способ использования программы — через графический интерфейс. Файл: `mp3_autocut_gui.py`.

### Возможности GUI:
- Все параметры нарезки и копирования доступны через удобную форму
- Можно сохранять и выбирать профили настроек (например, для разных сценариев)
- Профили сохраняют все настроенные параметры.
- Улучшенная структура интерфейса с группировкой настроек для большего удобства.
- Выбор папок через диалоговые окна
- Копирование на внешний диск — опционально (чекбокс)
- Логи выполнения отображаются в реальном времени
- Кнопка остановки процесса
- Возможность установки пользовательской иконки приложения (см. ниже).
- Всё работает локально, кроссплатформенно (Mac/Win/Linux)

## Возможности (общие для GUI и CLI)

- Рекурсивный поиск и обработка всех MP3 в папке
- Нарезка по тишине с гибкими параметрами
- Изменение скорости воспроизведения (0.5–2.0, экспериментально до 10)
- Пиковая нормализация громкости: каждый аудио-кусок может быть нормализован так, чтобы его самый громкий пик достигал заданного уровня в dBFS (например, -0.1 dBFS). Это помогает выровнять громкость без клиппинга. Нормализация опциональна и настраивается.
- Копирование и перемещение файлов с проверкой целостности (SHA256)
- Вставка голосового сообщения о прогрессе (TTS, Mac/Win/Linux) с возможностью ограничения частоты сообщений (не чаще каждых 5%)
- Подробные логи работы с индикацией прогресса на всех этапах
- Корректное склонение русских слов в TTS-сообщениях о прогрессе (например: 1 процент, 2 процента, 5 процентов, 1 час, 2 часа, 5 часов, 1 минута, 2 минуты, 5 минут и т.д.)

## Требования

- Python 3.6+ (рекомендуется 3.9+ для лучшей совместимости с зависимостями)
- `ffmpeg` (должен быть в PATH)

## Установка и первый запуск (Рекомендуемый способ — с venv)

1.  **Клонируйте репозиторий или скачайте файлы проекта.**
    Если у вас установлен Git:
    ```bash
    git clone https://github.com/YOUR_USERNAME/mp3-autocut-buddy.git # Замените на актуальный URL репозитория
    cd mp3-autocut-buddy
    ```
    Или просто скачайте ZIP-архив и распакуйте его.

2.  **Установите `ffmpeg`:**
    -   macOS: `brew install ffmpeg`
    -   Ubuntu/Debian: `sudo apt update && sudo apt install ffmpeg`
    -   Windows: Скачайте с [официального сайта ffmpeg](https://ffmpeg.org/download.html) и добавьте путь к папке `bin` (где находится `ffmpeg.exe`) в системную переменную PATH.

3.  **Создайте и активируйте виртуальное окружение (venv):**
    Находясь в корневой папке проекта (например, `mp3-autocut-buddy`), выполните:
    ```bash
    python3 -m venv .venv312
    ```
    Эта команда создаст папку `.venv312` с изолированным окружением Python.
    Активируйте его:
    -   macOS / Linux:
        ```bash
        source .venv312/bin/activate
        ```
    -   Windows (Command Prompt):
        ```bash
        .venv312\Scripts\activate.bat
        ```
    -   Windows (PowerShell):
        ```bash
        .venv312\Scripts\Activate.ps1
        ```
    После активации, ваша командная строка должна измениться, указывая на активное окружение (например, `(.venv312) your-prompt$`).

4.  **Установите зависимости проекта:**
    Когда виртуальное окружение активировано, установите все необходимые библиотеки:
    ```bash
    python -m pip install -r requirements.txt
   ```
    Или просто `pip install -r requirements.txt`, если `pip` корректно связан с venv.

5.  **Запустите GUI:**
    Убедитесь, что venv всё ещё активировано:
    ```bash
    python mp3_autocut_gui.py
    ```

## Быстрый запуск (macOS)

Для удобства созданы файлы быстрого запуска:

- **`setup_macos.command`** — первоначальная установка (двойной клик)
  - Проверяет Python и ffmpeg
  - Создаёт виртуальное окружение
  - Устанавливает все зависимости

- **`start_gui.command`** — запуск GUI программы (двойной клик)
  - Активирует виртуальное окружение
  - Запускает графический интерфейс
  - Работает из Finder двойным кликом

- **`start_gui.sh`** — запуск из терминала
  - Простой запуск: `./start_gui.sh`

## Пример типового сценария (с GUI и venv)

1.  Выполните шаги из раздела "Установка и первый запуск".
2.  Убедитесь, что ваше виртуальное окружение (`.venv312`) активировано.
3.  Запустите GUI: `python mp3_autocut_gui.py`.
4.  В интерфейсе выберите папку с исходными MP3 (`source_mp3` по умолчанию).
5.  Настройте желаемые параметры нарезки (длительность куска, скорость и т.д.) или выберите сохранённый профиль.
6.  Нажмите "Запустить".
7.  Готовые куски будут в папке результатов (`ready_mp3` по умолчанию, структура папок сохраняется).
8.  Если нужно, включите опцию "Копировать на внешний диск" и укажите путь. Файлы будут скопированы и затем перемещены из папки результатов в `copied_mp3`.

## Использование через командную строку (CLI)

Для тех, кто предпочитает командную строку или хочет автоматизировать процесс, доступен файл `split_mp3.py`. **Не забудьте активировать виртуальное окружение перед запуском!**

```bash
source .venv312/bin/activate  # macOS/Linux
# .venv312\Scripts\activate  # Windows
python split_mp3.py [параметры]
```

### Базовая обработка (CLI)
```bash
python split_mp3.py
```
Обычная нарезка: всё по дефолту (source_mp3 → ready_mp3, 100 сек, скорость 1.0)

### Кастомные параметры (CLI):
```bash
python split_mp3.py -i my_mp3s -o out_mp3s -d 300 -w 8 -t -35 -m 700 -s 1.25
```

### Только копирование и перемещение (CLI, без обработки):
```bash
python split_mp3.py --copy-only --output-dir ready_mp3 --copy-to /Volumes/DRIVE
```

### Все параметры CLI:
- `-i, --input-dir` — папка с исходными MP3 (по умолчанию: source_mp3)
- `-o, --output-dir` — папка для результатов (по умолчанию: ready_mp3)
- `-d, --duration` — желаемая длительность куска, сек (по умолчанию: 100)
- `-w, --window` — окно поиска тишины, сек (по умолчанию: 10)
- `-t, --threshold` — порог тишины, dBFS (по умолчанию: -40)
- `-m, --min-silence` — мин. длина тишины, мс (по умолчанию: 500, можно от 50)
- `-s, --speed` — коэффициент скорости (по умолчанию: 1.0, диапазон 0.5–10.0)
- `--skip-existing` — пропускать файлы, если уже есть результат
- `--tts-progress` — вставлять голосовое сообщение о прогрессе (процент прослушанного и длительность книги; на Mac — голос Yuri, на Win/Linux — pyttsx3)
- `--tts-progress-grid` — сообщение о прогрессе не чаще чем каждые 5%
- `--copy-only` — только копировать и перемещать, не обрабатывать
- `--copy-to` — путь для копирования (требуется для --copy-only или для копирования после обработки в GUI/CLI)
- `--enable-normalization` — включить пиковую нормализацию громкости.
- `--norm-dbfs` — целевой пиковый уровень для нормализации в dBFS (используется, если включена `--enable-normalization`). По умолчанию: -0.1.

### Примеры команд CLI

```bash
python split_mp3.py
```
Обычная нарезка: всё по дефолту (source_mp3 → ready_mp3, 100 сек, скорость 1.0)

```bash
python split_mp3.py -i audiobooks -o output -d 120 -w 10 -t -35 -m 1000
```
Нарезать все mp3 из папки audiobooks на куски по 2 минуты, искать паузы длиной от 1000 мс (1 сек) с порогом -35 dBFS в окне 10 сек, результат в папке output.

```bash
python split_mp3.py -s 1.5
```
Ускорить все mp3 в 1.5 раза.

```bash
python split_mp3.py --skip-existing
```
Пропускать файлы, если уже есть результат.

```bash
python split_mp3.py --copy-only --output-dir ready_mp3 --copy-to /Volumes/USB
```
Только скопировать все mp3 из папки ready_mp3 на внешний диск /Volumes/USB с проверкой целостности файлов (SHA256), затем переместить их в папку copied_mp3.

```bash
python split_mp3.py -i lectures -o chunks -d 120 -w 5 -t -45 -m 300 -s 0.8
```
Нарезать все mp3 из папки lectures на куски по 2 минуты, искать паузы длиной от 300 мс с порогом -45 dBFS в окне 5 сек, замедлить аудио до 0.8x, результат в папке chunks.

```bash
python split_mp3.py --tts-progress
```
Вставить голосовое сообщение о прогрессе в начало первого куска каждого файла.

```bash
python split_mp3.py --tts-progress --tts-progress-grid
```
Вставить голосовое сообщение о прогрессе, но не чаще чем каждые 5% (при 6%, 12%, 17%, 23% и т.д.).

```bash
python split_mp3.py --enable-normalization --norm-dbfs -0.5
```
Нарезать файлы с настройками по умолчанию, включив пиковую нормализацию до -0.5 dBFS.

```bash
python split_mp3.py -s 1.2 --enable-normalization
```
Ускорить аудио в 1.2 раза и применить пиковую нормализацию с целевым уровнем по умолчанию (-0.1 dBFS).

## Установка пользовательской иконки приложения (для GUI)

1.  Подготовьте файл иконки. Рекомендуется использовать формат `.png` (например, `app_icon.png`) размером 256x256 пикселей или более.
2.  Поместите файл иконки (с именем `app_icon.png`) в ту же директорию, где находится скрипт `mp3_autocut_gui.py`.
3.  При следующем запуске `mp3_autocut_gui.py` эта иконка будет использована для окна приложения и в Dock (на macOS).

## Примечания
- Для корректной работы `ffmpeg` должен быть установлен и доступен в PATH.
- Для TTS на Mac используется системный голос Yuri (команда `say`), на Windows/Linux — библиотека `pyttsx3` (устанавливается автоматически с зависимостями в venv).
- Вся основная логика нарезки и обработки находится в `split_mp3.py`, который используется и GUI.
- Все параметры CLI также можно посмотреть через `python split_mp3.py -h`.

## Решение проблем (Troubleshooting)

**1. Ошибка `command not found: python`, `python3` или `pip`, `pip3`**
   - **Симптом:** Терминал не распознает команды `python`, `python3`, `pip` или `pip3`.
   - **Причина:**
     - Python не установлен, или путь к нему не добавлен в системную переменную PATH.
     - Вы находитесь не в активированном виртуальном окружении (venv), где эти команды доступны.
   - **Решение:**
     - **Рекомендуется использовать venv.** Убедитесь, что вы создали и активировали venv согласно разделу "Установка". В активированном venv команды `python` и `pip` должны работать и указывать на версии из venv.
     - Если вы НЕ используете venv (не рекомендуется):
       - Убедитесь, что Python 3.6+ установлен. Проверьте `python3 --version`. Если не установлен, скачайте с [официального сайта Python](https://www.python.org/downloads/) и при установке **обязательно отметьте опцию "Add Python to PATH"** или аналогичную.
       - На macOS и Linux часто нужно использовать `python3` и `pip3`.
       - Если `pip` или `pip3` не найдены, попробуйте: `python3 -m pip install --upgrade pip` для установки/обновления pip.

**2. Ошибка `ModuleNotFoundError: No module named 'PyQt5'` (или `pydub`, `pyttsx3`)**
   - **Симптом:** При запуске скрипта (`mp3_autocut_gui.py` или `split_mp3.py`) возникает ошибка, что модуль не найден, например, `ModuleNotFoundError: No module named 'PyQt5'`.
   - **Причина:** Необходимые библиотеки не установлены в текущем окружении Python (особенно если venv не активировано или зависимости не установлены в нем).
   - **Решение:**
     - Убедитесь, что ваше **виртуальное окружение (venv) активировано**.
     - Находясь в активированном venv, установите все зависимости из файла `requirements.txt`:
       ```bash
       python -m pip install -r requirements.txt
       ```
     - Если ошибка сохраняется для конкретного модуля, попробуйте переустановить его явно (в активированном venv), например:
       ```bash
       python -m pip uninstall PyQt5
       python -m pip install PyQt5
       ```

**3. Ошибка `audioop` / `pydub` (особенно на macOS/старых Linux или со старыми версиями Python)**
   - **Симптом:** Ошибки при импорте или работе `pydub`, часто с упоминанием `audioop`. Может проявляться даже при использовании venv, если оно создано на основе старой версии Python.
   - **Причина:** Несовместимость старых версий Python (обычно до 3.8-3.9) с библиотекой `pydub`.
   - **Решение:**
     - **Обновите Python и venv:** Рекомендуется использовать Python 3.9+ (для macOS — Python 3.12 для наилучшей совместимости).
     - Если у вас установлена подходящая версия Python, но venv было создано ранее со старой версией, или вы хотите быть уверены, что используется нужная версия Python для venv, создайте (или пересоздайте) виртуальное окружение, явно указав интерпретатор Python:
       ```bash
       # Пример для Python 3.12 (убедитесь, что python3.12 доступен)
       python3.12 -m venv .venv312 
       source .venv312/bin/activate
       # Затем установите зависимости
       python -m pip install -r requirements.txt
       ```
       Замените `.venv312` на желаемое имя папки venv и `python3.12` на вашу актуальную команду для запуска нужной версии Python (например, `python3.9`, `python3.10` и т.д.). Если вы не уверены, какая команда соответствует нужной версии, проверьте с помощью `python3.X --version`.

**4. `ffmpeg` не найден**
   - **Симптом:** Сообщение "ffmpeg не найден или не доступен в PATH" при обработке файлов.
   - **Решение:** Следуйте инструкциям по установке `ffmpeg` из раздела "Установка и первый запуск". После установки перезапустите терминал/GUI.

**5. Проблемы с декодированием MP3 (`CouldntDecodeError`)**
   - **Симптом:** Сообщение в логах "Ошибка: Не удалось декодировать файл..."
   - **Решение:** Проверьте целостность MP3-файла, попробуйте открыть его в другом плеере.

**6. Низкое качество звука при сильном изменении скорости**
   - **Симптом:** Искажения звука при скорости > 2.0x или < 0.5x.
   - **Решение:** Для лучшего качества используйте скорость в диапазоне 0.5x-2.0x.

**7. Проблемы с TTS (голосовыми оповещениями)**
   - **Симптом:** Голосовые оповещения не работают, хотя опция включена.
   - **Решение:**
     - **macOS:** Проверьте работу команды `say "hello"` в терминале. Убедитесь, что голос `Yuri (Enhanced)` (или используемый по умолчанию) доступен.
     - **Windows/Linux:** Убедитесь, что `pyttsx3` установлен в вашем venv. Проверьте наличие TTS-движков и голосов в операционной системе и их настройки.

**8. "Зависание" при обработке большого количества файлов**
   - **Симптом:** Программа долго не отвечает или не показывает прогресс.
   - **Решение:** Наберитесь терпения, особенно для больших объемов или на медленных машинах. Следите за логами. Для теста попробуйте обработать меньший набор файлов.

**9. Копирование на внешний диск не работает**
    - **Симптом:** Ошибки при копировании, файлы не появляются на диске.
    - **Решение:** Проверьте правильность пути к диску, его подключение, наличие свободного места и прав на запись.

## Юнит-тесты склонения
В проекте есть юнит-тесты для проверки склонения русских слов. Запуск:
```
python split_mp3.py --test-plural
```
Покрыты все граничные случаи для процентов, часов, минут.
